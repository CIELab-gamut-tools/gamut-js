"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("t-matrix");function e(e){const r=(e=[...e]).length;let[o,a]=t.grid(e,e);o=t.reshape(o,r*r,1),a=t.reshape(a,r*r,1);const s=t.zeros(r*r,1).set(e[0]),n=t.zeros(r*r,1).set(e[r-1]),f=t.mcat([[s,o,a],[a,s,o],[o,a,s],[n,a,o],[o,n,a],[a,o,n]]),m=t.zeros(12*(r-1)*(r-1),3);let p=0;for(let t=0;t<6;t++)for(let e=0;e<r-1;e++)for(let o=0;o<r-1;o++){let a=r*r*t+r*e+o;m.set([p,p+1],":",[[a,a+r,a+1],[a+r,a+r+1,a+1]]),p+=2}return[m,f]}function r(e,r){const o=t.from([...t.rows(e)].map(([t,e])=>[t/e,1,(1-t-e)/e]));return r?product(o,r):o}function o(e){const r={},o=function*(t){if(null!=t){"string"!=typeof t&&"function"==typeof t[Symbol.iterator]||(t=[t]);for(let e of t)if("string"==typeof e)for(let t of e.match(/[^\r\n]+/g))yield t.split("#")[0]}}(e)[Symbol.iterator]();let a,s,n,f,m;const p=()=>(a=o.next()).done;for(;!p();){const[e,...o]=a.value.split(/\s+/);if(/^CGATS/.test(e))r.version=e;else switch(e){case"BEGIN_DATA_FORMAT":for(n=[];!p()&&"END_DATA_FORMAT"!==a.value;)n.push(...a.value.toUpperCase().split(/\s+/));break;case"NUMBER_OF_SETS":s=Number.parseInt(o[0]);break;case"BEGIN_DATA":if(!s||!n)throw new Error("readCGATS: NUMBER_OF_SETS and *_DATA_FORMAT required before BEGIN_DATA");f=t.zeros(s,n.length),m=0;let i=n.indexOf("SAMPLEID");for(-1===i&&(i=n.indexOf("SAMPLE_ID")),-1===i&&(i=n.indexOf("SAMPLE_NO"));!p()&&"END_DATA"!==a.value;){const t=a.value.split(/\s+/).map(Number.parseFloat);if(i>=0){if(m=t[i],m<1||m>s)throw new Error("readCGATS: SampleID outside the range 1..NUMBER_OF_SETS");f.set(m-1,":",[t])}else f.set(m++-1,":",[t])}if(m!==s)throw new Error("readCGATS: data rows does not match NUMBER_OF_SETS");r.format={};for(let t=0;t<n.length;t++)r.format[n[t]]=t;r.data=f;break;default:r[e]=o.join(" ")}}return r}function a(t){t.gsv=[...new Set(t.RGB)].sort((t,e)=>t-e);const[r,o]=e(t.gsv),a=function(t,e,r){const o=new Map(r.map((t,e)=>[t,e])),a=r.length,s=([t,e,r])=>o.get(t)+a*(o.get(e)+a*o.get(r)),n=new Map(e.toJSON().map((t,e)=>[s(t),e]));return t.toJSON().map(t=>n.get(s(t)))}(o,t.RGB,t.gsv);if(a.indexOf(void 0)>=0)throw new Error("GAMUT:: Missing RGB data");return t.TRI=r.map(t=>a[t]),s(t)}function s(e){return e.RGBmax=e.gsv[e.gsv.length-1],e.XYZn=e.XYZ.get([...t.min(e.RGB,null,2)].indexOf(e.RGBmax),":"),e.caXYZn||(e.caXYZn=t.from([[.9642957,1,.8251046]])),e.caXYZ=function(e,r,o){const a=t.from([[.8951,.2664,-.1614],[-.7502,1.7135,.0367],[.0389,-.0685,1.0296]]).t,s=t.mult(r,a),n=t.mult(o,a),f=t.diag(t.mapMany(n,s,(t,e)=>t/e).t),m=t.div(t.mult(a,f),a);return t.mult(e,m)}(e.XYZ,e.XYZn,e.caXYZn),e.LAB=function(e,r){const o=t.mapMany(e,r,(t,e)=>t/e).map(t=>t<=216/24389?t*(24389/3132)+16/116:Math.pow(t,1/3));return t.from([...t.rows(o)].map(([t,e,r])=>[116*e-16,500*(t-e),200*(e-r)]))}(e.caXYZ,e.caXYZn),n(e)}function n(e){e.Lsteps||(e.Lsteps=100),e.hsteps||(e.hsteps=360);const{TRI:r,LAB:o,Lsteps:a,hsteps:s}=e,n=o.get(":",[1,2,0]),m=t.max(n.get([...r.get(":",0)],2),n.get([...r.get(":",1)],2),n.get([...r.get(":",2)],2)),p=t.min(n.get([...r.get(":",0)],2),n.get([...r.get(":",1)],2),n.get([...r.get(":",2)],2)),i=2*Math.PI/s,l=new Array(a);for(let e=0;e<a;e++){let o=100*(e+.5)/a,u=t.from([[0,0,o]]),g=(c=t.mapMany(p,m,(t,e)=>t<=o&&o<e),[...c].map((t,e)=>[t,e]).filter(t=>t[0]).map(t=>t[1])),h=n.get([...r.get(g,0)],":"),d=n.get([...r.get(g,1)],":"),w=n.get([...r.get(g,2)],":"),M=t.mapMany(d,h,(t,e)=>t-e),R=t.mapMany(w,h,(t,e)=>t-e),y=t.mapMany(u,h,(t,e)=>t-e),A=t.cross(R,M,2),B=t.cross(R,y,2),G=t.cross(y,M,2);l[e]=f([...A.get(":",[0,1])],[...B.get(":",[0,1])],[...G.get(":",[0,1])],[...t.sum(t.product(R,G),null,2)],s,i)}var c;return e.cylmap=l,e}function f(t,e,r,o,a,s){const n=o.length,f=new Array(a);for(let m=0;m<a;m++){const a=[],p=(m+.5)*s,i=Math.sin(p),l=Math.cos(p);let c,u,g,h;for(let s=0,f=0;s<n;s++,f+=2)c=1/(i*t[f]+l*t[f+1]),(h=c*o[s])>0&&(u=c*(i*e[f]+l*e[f+1]))>=0&&(g=c*(i*r[f]+l*r[f+1]))>=0&&u+g<=1&&a.push([Math.sign(c),h]);f[m]=a}return f}const m={d50:[.3457,.3585],d55:[.3324,.3474],d60:[.32168,.33767],d65:[.3127,.329],d75:[.299,.3149]},p={default:{driveMapping:t=>t,gamma:2.4,black:null,blackRatio:0,steps:10,white:"d65",RGBxy:[[.64,.33],[.3,.6],[.15,.06]]},srgb:{white:"d65",RGBxy:[[.64,.33],[.3,.6],[.15,.06]],gamma:t=>t>.04045?Math.pow((200*t+11)/211,2.4):25*t/323},"bt.2020":{white:"d65",RGBxy:[[.708,.292],[.17,.797],[.131,.046]],gamma:2.4},"dci-p3":{white:[.314,.351],RGBxy:[[.68,.32],[.265,.69],[.15,.06]],gamma:2.4},"d65-p3":{white:"d65",RGBxy:[[.68,.32],[.265,.69],[.15,.06]],gamma:2.4},"d50-p3":{white:"d50",RGBxy:[[.68,.32],[.265,.69],[.15,.06]],gamma:2.4}};exports.fromCgats=function(t,e){const r=o(t),s=["RGB_R","RGB_G","RGB_B"],n=["XYZ_X","XYZ_Y","XYZ_Z"];for(let t of[...s,...n])if(!r.format.hasOwnProperty(t))throw new Error("GAMUT:: Cgats file must have the following data - "+PROPS.join(", "));return r.RGB=r.data.get(":",s.map(t=>r.format[t])),r.XYZ=r.data.get(":",n.map(t=>r.format[t])),Object.assign(r,e),a(r)},exports.fromTRILAB=n,exports.fromTRIXYZ=s,exports.fromXYZ=a,exports.gamutVolume=function(t){let e=2*Math.PI/t.hsteps,r=100/t.Lsteps,o=0;for(let e=0;e<t.Lsteps;e++)for(let r=0;r<t.hsteps;r++){const a=t.cylmap[e][r];for(let t=0;t<a.length;t++)o+=a[t][0]*a[t][1]*a[t][1]}return o*r*e/2},exports.makeSynthetic=function(o,s){s="string"==typeof o?Object.assign({},p.default,p[o.toLowerCase()],s):Object.assign({},p.default,o);let{white:n,RGBxy:f,gamma:i,black:l,blackRatio:c,steps:u,colorantXYZ:g,driveMapping:h}=s,d="function"==typeof i?i:t=>Math.pow(t,i),w=t.from([h([1,1,1])]);if(g)g=t.from(g);else{for(;"string"==typeof n;)n=m[n]||p[n].white;n=t.from([n]);let e=r(n),o=r(t.from(f)),a=t.div(e,o);g=t.product(o,a.t),w.length>3&&(g=t.vcat([g,e]))}let M=t.mult(w,g),R=t.zeros(1,3);if(c){if(l)for(;"string"==typeof l;)l=m[l]||p[l].white;else l=n;R=r(l,M.get(0,1)/(1/c-1))}let y=e(t.from([0,":",u]))[1];const A=u+1;y=t.from([...new Map([...t.rows(y)].map(([t,e,r])=>[t+A*(e+A*r),[t,e,r]])).values()]),y=y.map(t=>t/u);let B=y.map(d),G=t.from([...t.rows(B)].map(h));return a({RGB:y,XYZ:t.sum(t.mult(G,g),R)})},exports.rings=function(e,r){const o=2*Math.PI/e.hsteps,a=100/e.Lsteps*o/2,s=t.from(e.cylmap.map(t=>t.map(t=>{let e=0;for(let r of t)e+=r[0]*r[1]*r[1]*a;return e}))),n=t.vcat(t.zeros(1,e.hsteps),t.cumsum(s).map(t=>Math.pow(2*t/o,.5))),f=t.gridInterp1(n,r),m=t.from([[o/2,"::",o,2*Math.PI]]);return[t.product(m.map(Math.sin),f),t.product(m.map(Math.cos),f),f,t.sum(s)]};
